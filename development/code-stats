#!/bin/bash

# Code Statistics Script
# Analyzes code repositories and provides detailed statistics

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
MAGENTA='\033[0;35m'
CYAN='\033[0;36m'
WHITE='\033[1;37m'
NC='\033[0m'

# Default configuration
SHOW_DETAILS=false
SHOW_AUTHORS=false
SHOW_TIMELINE=false
TARGET_DIR="."

# Function to display usage
usage() {
    echo "Code Statistics Analyzer"
    echo
    echo "Usage: $0 [OPTIONS] [directory]"
    echo
    echo "Options:"
    echo "  -d, --details       Show detailed file statistics"
    echo "  -a, --authors       Show author statistics (requires git)"
    echo "  -t, --timeline      Show commit timeline (requires git)"
    echo "  -h, --help          Show this help message"
    echo
    echo "Examples:"
    echo "  $0                  # Analyze current directory"
    echo "  $0 -d /path/to/repo # Detailed analysis of specific directory"
    echo "  $0 -a -t            # Include author and timeline stats"
    exit 0
}

# Parse command line arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        -d|--details)
            SHOW_DETAILS=true
            shift
            ;;
        -a|--authors)
            SHOW_AUTHORS=true
            shift
            ;;
        -t|--timeline)
            SHOW_TIMELINE=true
            shift
            ;;
        -h|--help)
            usage
            ;;
        -*)
            echo "Unknown option: $1"
            usage
            ;;
        *)
            TARGET_DIR="$1"
            shift
            ;;
    esac
done

# Check if target directory exists
if [ ! -d "$TARGET_DIR" ]; then
    echo -e "${RED}âŒ Error: Directory '$TARGET_DIR' does not exist${NC}"
    exit 1
fi

cd "$TARGET_DIR"

# Function to get file count by extension
count_files_by_extension() {
    find . -type f -name ".*" -prune -o -type f -print | \
    grep -E '\.[a-zA-Z0-9]+$' | \
    sed 's/.*\.//' | \
    sort | uniq -c | sort -nr
}

# Function to get total lines of code
count_lines() {
    local pattern="$1"
    find . -type f -name ".*" -prune -o -type f -name "$pattern" -print0 | \
    xargs -0 wc -l 2>/dev/null | tail -1 | awk '{print $1}' || echo "0"
}

# Function to count lines by file type
count_lines_by_type() {
    local ext="$1"
    find . -type f -name "*.$ext" -exec wc -l {} + 2>/dev/null | \
    tail -1 | awk '{print $1}' || echo "0"
}

# Function to get largest files
get_largest_files() {
    find . -type f -name ".*" -prune -o -type f -print0 | \
    xargs -0 wc -l 2>/dev/null | \
    head -n -1 | sort -nr | head -10
}

# Function to check if we're in a git repository
is_git_repo() {
    git rev-parse --git-dir > /dev/null 2>&1
}

echo -e "${WHITE}========================================${NC}"
echo -e "${WHITE}         CODE STATISTICS                ${NC}"
echo -e "${WHITE}========================================${NC}"
echo -e "${GREEN}Directory:${NC} $(pwd)"
echo -e "${GREEN}Analysis Date:${NC} $(date)"
echo

# Basic file statistics
echo -e "${CYAN}ðŸ“Š FILE OVERVIEW${NC}"
TOTAL_FILES=$(find . -type f -name ".*" -prune -o -type f -print | wc -l)
TOTAL_DIRS=$(find . -type d -name ".*" -prune -o -type d -print | wc -l)
echo -e "${GREEN}Total files:${NC} $TOTAL_FILES"
echo -e "${GREEN}Total directories:${NC} $TOTAL_DIRS"
echo

# File types
echo -e "${CYAN}ðŸ“ FILE TYPES${NC}"
echo -e "${GREEN}Top file extensions:${NC}"
count_files_by_extension | head -10 | while read count ext; do
    printf "  %-10s %s files\n" ".$ext" "$count"
done
echo

# Lines of code analysis
echo -e "${CYAN}ðŸ“ LINES OF CODE${NC}"

# Common programming languages
declare -A LANGUAGES=(
    ["py"]="Python"
    ["js"]="JavaScript"
    ["ts"]="TypeScript"
    ["java"]="Java"
    ["cpp"]="C++"
    ["c"]="C"
    ["h"]="Headers"
    ["go"]="Go"
    ["rs"]="Rust"
    ["php"]="PHP"
    ["rb"]="Ruby"
    ["sh"]="Shell"
    ["html"]="HTML"
    ["css"]="CSS"
    ["scss"]="SCSS"
    ["json"]="JSON"
    ["xml"]="XML"
    ["yml"]="YAML"
    ["yaml"]="YAML"
    ["md"]="Markdown"
    ["txt"]="Text"
)

TOTAL_LOC=0
for ext in "${!LANGUAGES[@]}"; do
    lines=$(count_lines_by_type "$ext")
    if [ "$lines" -gt 0 ]; then
        printf "  %-12s %8s lines\n" "${LANGUAGES[$ext]}" "$lines"
        TOTAL_LOC=$((TOTAL_LOC + lines))
    fi
done

echo -e "${GREEN}Total LOC:${NC} $TOTAL_LOC"
echo

# Detailed file analysis
if [ "$SHOW_DETAILS" = true ]; then
    echo -e "${CYAN}ðŸ“‹ LARGEST FILES (by lines)${NC}"
    get_largest_files | while read lines file; do
        printf "  %8s lines  %s\n" "$lines" "$file"
    done
    echo
fi

# Git statistics (if in a git repository)
if is_git_repo; then
    echo -e "${CYAN}ðŸ“¦ GIT REPOSITORY STATS${NC}"
    
    # Basic git info
    TOTAL_COMMITS=$(git rev-list --all --count 2>/dev/null || echo "0")
    BRANCHES=$(git branch -r | wc -l 2>/dev/null || echo "0")
    CONTRIBUTORS=$(git log --format='%ae' | sort -u | wc -l 2>/dev/null || echo "0")
    
    echo -e "${GREEN}Total commits:${NC} $TOTAL_COMMITS"
    echo -e "${GREEN}Branches:${NC} $BRANCHES"
    echo -e "${GREEN}Contributors:${NC} $CONTRIBUTORS"
    
    # Repository age
    FIRST_COMMIT=$(git log --reverse --format="%ci" | head -1 | cut -d' ' -f1 2>/dev/null || echo "unknown")
    LAST_COMMIT=$(git log -1 --format="%ci" | cut -d' ' -f1 2>/dev/null || echo "unknown")
    echo -e "${GREEN}First commit:${NC} $FIRST_COMMIT"
    echo -e "${GREEN}Last commit:${NC} $LAST_COMMIT"
    echo
    
    # Author statistics
    if [ "$SHOW_AUTHORS" = true ]; then
        echo -e "${CYAN}ðŸ‘¥ TOP CONTRIBUTORS${NC}"
        git shortlog -sn --all | head -10 | while read commits author; do
            printf "  %8s commits  %s\n" "$commits" "$author"
        done
        echo
        
        echo -e "${CYAN}ðŸ“ˆ COMMIT ACTIVITY (last 30 days)${NC}"
        git log --since="30 days ago" --format="%cd" --date=short | \
        sort | uniq -c | sort -nr | head -10 | while read count date; do
            printf "  %s  %3s commits\n" "$date" "$count"
        done
        echo
    fi
    
    # Timeline analysis
    if [ "$SHOW_TIMELINE" = true ]; then
        echo -e "${CYAN}ðŸ“… COMMIT TIMELINE (last 12 months)${NC}"
        for i in {11..0}; do
            month=$(date -d "$i months ago" +"%Y-%m" 2>/dev/null || date -v-${i}m +"%Y-%m" 2>/dev/null || echo "unknown")
            if [ "$month" != "unknown" ]; then
                commits=$(git log --since="$month-01" --until="$month-31" --oneline | wc -l 2>/dev/null || echo "0")
                printf "  %s  %3s commits\n" "$month" "$commits"
            fi
        done
        echo
    fi
    
    # Recent activity
    echo -e "${CYAN}ðŸ•’ RECENT COMMITS${NC}"
    git log --oneline -10 2>/dev/null | while read commit message; do
        printf "  %s  %s\n" "$commit" "$message"
    done
    echo
else
    echo -e "${YELLOW}â„¹  Not a git repository - skipping git statistics${NC}"
    echo
fi

# Code complexity indicators
echo -e "${CYAN}ðŸ”§ CODE COMPLEXITY INDICATORS${NC}"

# Function count (rough estimate)
FUNCTION_COUNT=0
for pattern in "def " "function " "func " "fn " "public " "private " "protected "; do
    count=$(grep -r "$pattern" . --include="*.py" --include="*.js" --include="*.ts" --include="*.java" --include="*.go" --include="*.rs" 2>/dev/null | wc -l || echo "0")
    FUNCTION_COUNT=$((FUNCTION_COUNT + count))
done
echo -e "${GREEN}Estimated functions:${NC} $FUNCTION_COUNT"

# TODO/FIXME count
TODO_COUNT=$(grep -r -i "todo\|fixme\|hack\|xxx" . --include="*.py" --include="*.js" --include="*.ts" --include="*.java" --include="*.go" --include="*.rs" --include="*.c" --include="*.cpp" --include="*.h" 2>/dev/null | wc -l || echo "0")
echo -e "${GREEN}TODO/FIXME comments:${NC} $TODO_COUNT"

# Long lines (>120 characters)
LONG_LINES=$(find . -name "*.py" -o -name "*.js" -o -name "*.ts" -o -name "*.java" -o -name "*.go" -o -name "*.rs" | xargs awk 'length > 120 {count++} END {print count+0}' 2>/dev/null || echo "0")
echo -e "${GREEN}Long lines (>120 chars):${NC} $LONG_LINES"

echo

# Project insights
echo -e "${CYAN}ðŸ’¡ PROJECT INSIGHTS${NC}"

# Determine primary language
PRIMARY_LANG=""
MAX_LINES=0
for ext in "${!LANGUAGES[@]}"; do
    lines=$(count_lines_by_type "$ext")
    if [ "$lines" -gt "$MAX_LINES" ]; then
        MAX_LINES=$lines
        PRIMARY_LANG="${LANGUAGES[$ext]}"
    fi
done

if [ -n "$PRIMARY_LANG" ]; then
    echo -e "${GREEN}Primary language:${NC} $PRIMARY_LANG ($MAX_LINES lines)"
fi

# Project size assessment
if [ "$TOTAL_LOC" -lt 1000 ]; then
    SIZE="Small"
elif [ "$TOTAL_LOC" -lt 10000 ]; then
    SIZE="Medium"
elif [ "$TOTAL_LOC" -lt 100000 ]; then
    SIZE="Large"
else
    SIZE="Very Large"
fi
echo -e "${GREEN}Project size:${NC} $SIZE project"

# Development activity
if is_git_repo; then
    RECENT_COMMITS=$(git log --since="7 days ago" --oneline | wc -l 2>/dev/null || echo "0")
    if [ "$RECENT_COMMITS" -gt 10 ]; then
        ACTIVITY="Very Active"
    elif [ "$RECENT_COMMITS" -gt 3 ]; then
        ACTIVITY="Active"
    elif [ "$RECENT_COMMITS" -gt 0 ]; then
        ACTIVITY="Low Activity"
    else
        ACTIVITY="Inactive"
    fi
    echo -e "${GREEN}Development activity:${NC} $ACTIVITY ($RECENT_COMMITS commits this week)"
fi

echo
echo -e "${WHITE}========================================${NC}"
echo -e "${BLUE}ðŸ’¡ Tips:${NC}"
echo -e "  â€¢ Use ${YELLOW}--details${NC} for file-by-file breakdown"
echo -e "  â€¢ Use ${YELLOW}--authors${NC} for contributor analysis"
echo -e "  â€¢ Use ${YELLOW}--timeline${NC} for historical trends"
