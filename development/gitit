#!/bin/bash

# Auto-commit script that generates commit messages or PR drafts using LLM APIs

set -e

show_help() {
  cat << 'EOF'
Usage: gitit [OPTIONS]

Generate commit messages or PR drafts using LLM APIs.

Options:
  -h, --help          Show this help message
  --pr                Generate PR title and description for branch
  -b, --base BRANCH   Base branch for PR comparison (default: master or main)
  -l, --limit CHARS   Commit message character limit (default: 72, use -1 for detailed)
  -m, --model MODEL   Model to use (overrides LLM_MODEL env var)

Environment variables:
  LLM_PROVIDER    Provider: "nvidia" (default) or "openai"
  LLM_API_KEY     API key (falls back to NVIDIA_API_KEY or OPENAI_API_KEY)
  LLM_MODEL       Model to use (optional, uses provider default)
  LLM_API_URL     Custom API URL (optional, uses provider default)

Examples:
  gitit                        # Generate commit message for staged changes
  gitit -l -1                  # Generate detailed commit message
  gitit -m gpt-4o              # Use a specific model
  gitit --pr                   # Generate PR draft (compare to master/main)
  gitit --pr -b develop        # Generate PR draft comparing to develop
EOF
  exit 0
}

# Source /etc/environment if it exists (with export)
if [ -f /etc/environment ]; then
  set -a
  . /etc/environment
  set +a
fi

# Parse arguments
MODE="commit"
BASE_BRANCH=""
MSG_LIMIT="72"
MODEL_OVERRIDE=""

while [ $# -gt 0 ]; do
  case "$1" in
    -h|--help)
      show_help
      ;;
    --pr)
      MODE="pr"
      shift
      ;;
    -b|--base)
      BASE_BRANCH="$2"
      shift 2
      ;;
    -l|--limit)
      MSG_LIMIT="$2"
      shift 2
      ;;
    -m|--model)
      MODEL_OVERRIDE="$2"
      shift 2
      ;;
    *)
      echo "Unknown option: $1"
      echo "Use --help for usage information."
      exit 1
      ;;
  esac
done

# Verify we're in a git repository
if ! git rev-parse --git-dir >/dev/null 2>&1; then
  echo "Error: Not a git repository."
  exit 1
fi

# Provider configuration
PROVIDER="${LLM_PROVIDER:-nvidia}"

case "$PROVIDER" in
  nvidia)
    DEFAULT_URL="https://integrate.api.nvidia.com/v1/chat/completions"
    DEFAULT_MODEL="nvidia/nemotron-3-nano-30b-a3b"
    API_KEY="${LLM_API_KEY:-$NVIDIA_API_KEY}"
    ;;
  openai)
    DEFAULT_URL="https://api.openai.com/v1/chat/completions"
    DEFAULT_MODEL="gpt-4o-mini"
    API_KEY="${LLM_API_KEY:-$OPENAI_API_KEY}"
    ;;
  *)
    echo "Error: Unknown provider '$PROVIDER'. Use 'nvidia' or 'openai'."
    exit 1
    ;;
esac

API_URL="${LLM_API_URL:-$DEFAULT_URL}"
MODEL="${MODEL_OVERRIDE:-${LLM_MODEL:-$DEFAULT_MODEL}}"

# Validate API key
if [ -z "$API_KEY" ]; then
  PROVIDER_UPPER=$(echo "$PROVIDER" | tr '[:lower:]' '[:upper:]')
  echo "Error: No API key found."
  echo "Set LLM_API_KEY or ${PROVIDER_UPPER}_API_KEY environment variable."
  exit 1
fi

# Get diff based on mode
if [ "$MODE" = "pr" ]; then
  # Use provided base branch or detect master/main
  if [ -z "$BASE_BRANCH" ]; then
    if git rev-parse --verify master >/dev/null 2>&1; then
      BASE_BRANCH="master"
    else
      BASE_BRANCH="main"
    fi
  fi

  # Verify base branch exists
  if ! git rev-parse --verify "$BASE_BRANCH" >/dev/null 2>&1; then
    echo "Error: Base branch '$BASE_BRANCH' not found."
    exit 1
  fi

  GIT_DIFF=$(git diff "$BASE_BRANCH"...HEAD)
  COMMITS=$(git log "$BASE_BRANCH"..HEAD --oneline)

  if [ -z "$GIT_DIFF" ]; then
    echo "No changes found compared to $BASE_BRANCH."
    exit 1
  fi
else
  GIT_DIFF=$(git diff --cached)

  if [ -z "$GIT_DIFF" ]; then
    echo "No staged changes found. Use 'git add' first."
    exit 1
  fi
fi

# Build the JSON payload to a temp file
PAYLOAD_FILE=$(mktemp)
trap "rm -f $PAYLOAD_FILE" EXIT

if [ "$MODE" = "pr" ]; then
  PROMPT="Write a GitHub Pull Request title and description for these changes. Do NOT include the diff in your output.

Format your response EXACTLY as (no extra text before or after):
TITLE: <a concise PR title, less than 72 characters>
BODY:
## Summary
<2-3 bullet points summarizing the changes>

## Changes
<list of specific changes made>

Commits in this branch:
$COMMITS

Diff:
$GIT_DIFF"
else
  if [ "$MSG_LIMIT" = "-1" ]; then
    PROMPT="Write a detailed git commit message for this diff. Follow Conventional Commits format.

Include:
- A subject line (first line, under 72 chars)
- A blank line
- A detailed body explaining WHAT changed and WHY

Return ONLY the commit message, no quotes or markdown:

$GIT_DIFF"
  else
    PROMPT="Write a concise git commit message for this diff. Follow Conventional Commits. Use LESS THAN $MSG_LIMIT characters. Return ONLY the subject line, no quotes:

$GIT_DIFF"
  fi
fi

jq -n --arg prompt "$PROMPT" --arg model "$MODEL" \
  '{
    model: $model,
    messages: [
      {
        role: "user",
        content: $prompt
      }
    ],
    temperature: 0.1,
    top_p: 1,
    max_tokens: 4096,
    stream: false
  }' > "$PAYLOAD_FILE"

# Call the API (fallback to reasoning field for nvidia models if content is null)
RESPONSE=$(curl --silent --request POST \
    --url "$API_URL" \
    --header "Authorization: Bearer $API_KEY" \
    --header "Accept: application/json" \
    --header "Content-Type: application/json" \
    --data @"$PAYLOAD_FILE" | jq -r '.choices[0].message | if .content != null then .content else .reasoning // .reasoning_content // "" end' | sed '/^$/d')

if [ -z "$RESPONSE" ] || [ "$RESPONSE" = "null" ]; then
  echo "Error: Could not generate content. Check your API key or connection."
  exit 1
fi

# Output based on mode
if [ "$MODE" = "pr" ]; then
  # Extract title and body (stop at "Commits in this branch:" or "Diff:")
  TITLE=$(echo "$RESPONSE" | grep -m1 "^TITLE:" | sed 's/^TITLE:[[:space:]]*//')
  BODY=$(echo "$RESPONSE" | sed -n '/^BODY:/,/^Commits in this branch:\|^Diff:/p' | grep -v "^BODY:\|^Commits in this branch:\|^Diff:" | sed '/^$/d')

  if [ -z "$TITLE" ]; then
    # Fallback: use first line as title
    TITLE=$(echo "$RESPONSE" | head -n 1)
    BODY=$(echo "$RESPONSE" | tail -n +2 | sed '/^Commits in this branch:/,$d' | sed '/^Diff:/,$d')
  fi

  echo "# PR Draft (comparing to $BASE_BRANCH)"
  echo ""
  echo "Title: $TITLE"
  echo ""
  echo "Body:"
  echo "$BODY"
  echo ""
  echo "---"
  echo "# Command to create PR:"
  echo "gh pr create --base \"$BASE_BRANCH\" --title \"$TITLE\" --body \"\$(cat <<'EOF'"
  echo "$BODY"
  echo "EOF"
  echo ")\""
else
  if [ "$MSG_LIMIT" = "-1" ]; then
    # Detailed mode: use full response with heredoc
    echo "git commit -m \"\$(cat <<'EOF'"
    echo "$RESPONSE"
    echo "EOF"
    echo ")\""
  else
    COMMIT_MSG=$(echo "$RESPONSE" | head -n 1)
    echo "git commit -m \"$COMMIT_MSG\""
  fi
fi
