#!/bin/bash

# Network Information Script
# Displays comprehensive network configuration and connectivity information

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
MAGENTA='\033[0;35m'
CYAN='\033[0;36m'
WHITE='\033[1;37m'
NC='\033[0m'

# Function to check if command exists
command_exists() {
    command -v "$1" >/dev/null 2>&1
}

# Function to get default gateway
get_default_gateway() {
    if command_exists ip; then
        ip route | grep default | awk '{print $3}' | head -1
    elif command_exists route; then
        route -n | grep '^0.0.0.0' | awk '{print $2}' | head -1
    else
        echo "unknown"
    fi
}

# Function to get public IP
get_public_ip() {
    local public_ip=""
    
    # Try multiple services
    for service in "ifconfig.me" "ipecho.net/plain" "icanhazip.com" "ident.me"; do
        public_ip=$(curl -s -m 5 "$service" 2>/dev/null | grep -E '^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$' | head -1)
        if [ -n "$public_ip" ]; then
            echo "$public_ip"
            return 0
        fi
    done
    
    echo "Unable to retrieve"
}

# Function to get DNS servers
get_dns_servers() {
    if [ -f /etc/resolv.conf ]; then
        grep "^nameserver" /etc/resolv.conf | awk '{print $2}' | tr '\n' ', ' | sed 's/,$//'
    else
        echo "Not available"
    fi
}

# Function to test connectivity
test_connectivity() {
    local host="$1"
    local name="$2"
    
    if ping -c 1 -W 3 "$host" >/dev/null 2>&1; then
        echo -e "${GREEN}‚úì $name${NC}"
        return 0
    else
        echo -e "${RED}‚úó $name${NC}"
        return 1
    fi
}

# Function to get network interface details
get_interface_details() {
    local interface="$1"
    
    echo -e "${CYAN}Interface: $interface${NC}"
    
    # Get IP address
    if command_exists ip; then
        local ipv4=$(ip addr show "$interface" 2>/dev/null | grep "inet " | awk '{print $2}' | head -1)
        local ipv6=$(ip addr show "$interface" 2>/dev/null | grep "inet6" | grep -v "fe80" | awk '{print $2}' | head -1)
    elif command_exists ifconfig; then
        local ipv4=$(ifconfig "$interface" 2>/dev/null | grep "inet " | awk '{print $2}' | head -1)
        local ipv6=$(ifconfig "$interface" 2>/dev/null | grep "inet6" | grep -v "fe80" | awk '{print $2}' | head -1)
    fi
    
    # Get MAC address
    local mac=""
    if command_exists ip; then
        mac=$(ip link show "$interface" 2>/dev/null | grep "link/ether" | awk '{print $2}')
    elif command_exists ifconfig; then
        mac=$(ifconfig "$interface" 2>/dev/null | grep "ether" | awk '{print $2}')
    fi
    
    # Get interface state
    local state="unknown"
    if command_exists ip; then
        state=$(ip link show "$interface" 2>/dev/null | grep -o "state [A-Z]*" | awk '{print $2}')
    fi
    
    # Get speed (if available)
    local speed="unknown"
    if [ -f "/sys/class/net/$interface/speed" ]; then
        local speed_val=$(cat "/sys/class/net/$interface/speed" 2>/dev/null)
        if [ "$speed_val" != "-1" ] && [ -n "$speed_val" ]; then
            speed="${speed_val} Mbps"
        fi
    fi
    
    echo -e "  ${GREEN}IPv4:${NC} ${ipv4:-Not assigned}"
    echo -e "  ${GREEN}IPv6:${NC} ${ipv6:-Not assigned}"
    echo -e "  ${GREEN}MAC:${NC} ${mac:-Not available}"
    echo -e "  ${GREEN}State:${NC} $state"
    echo -e "  ${GREEN}Speed:${NC} $speed"
    echo
}

# Function to show wireless information
show_wireless_info() {
    if command_exists iwconfig; then
        echo -e "${CYAN}üì∂ WIRELESS INFORMATION${NC}"
        
        # Get wireless interfaces
        local wireless_interfaces=$(iwconfig 2>/dev/null | grep "IEEE 802.11" | awk '{print $1}')
        
        if [ -n "$wireless_interfaces" ]; then
            for interface in $wireless_interfaces; do
                echo -e "${YELLOW}Interface: $interface${NC}"
                
                # Get SSID
                local ssid=$(iwconfig "$interface" 2>/dev/null | grep "ESSID" | cut -d'"' -f2)
                
                # Get signal strength
                local signal=$(iwconfig "$interface" 2>/dev/null | grep "Signal level" | awk '{print $4}' | cut -d'=' -f2)
                
                # Get frequency
                local freq=$(iwconfig "$interface" 2>/dev/null | grep "Frequency" | awk '{print $2}' | cut -d':' -f2)
                
                echo -e "  ${GREEN}SSID:${NC} ${ssid:-Not connected}"
                echo -e "  ${GREEN}Signal:${NC} ${signal:-Not available}"
                echo -e "  ${GREEN}Frequency:${NC} ${freq:-Not available}"
                echo
            done
        else
            echo -e "${BLUE}No wireless interfaces found${NC}"
            echo
        fi
    else
        echo -e "${YELLOW}iwconfig not available - install wireless-tools for WiFi info${NC}"
        echo
    fi
}

# Function to show active connections
show_active_connections() {
    echo -e "${CYAN}üîó ACTIVE CONNECTIONS${NC}"
    
    if command_exists ss; then
        echo -e "${YELLOW}TCP Connections:${NC}"
        ss -tuln | grep LISTEN | head -10 | while read line; do
            echo "  $line"
        done
    elif command_exists netstat; then
        echo -e "${YELLOW}TCP Connections:${NC}"
        netstat -tuln | grep LISTEN | head -10 | while read line; do
            echo "  $line"
        done
    else
        echo -e "${RED}Neither ss nor netstat available${NC}"
    fi
    echo
}

# Function to show routing table
show_routing_table() {
    echo -e "${CYAN}üó∫Ô∏è  ROUTING TABLE${NC}"
    
    if command_exists ip; then
        ip route | head -10 | while read line; do
            echo "  $line"
        done
    elif command_exists route; then
        route -n | head -10 | while read line; do
            echo "  $line"
        done
    else
        echo -e "${RED}No routing command available${NC}"
    fi
    echo
}

# Function to perform speed test (basic)
perform_speed_test() {
    echo -e "${CYAN}üöÄ BASIC SPEED TEST${NC}"
    echo -e "${YELLOW}Testing download speed (approximate)...${NC}"
    
    # Download a small file and measure speed
    local start_time=$(date +%s.%N)
    local test_file=$(mktemp)
    
    if curl -s -o "$test_file" -m 10 "http://speedtest.ftp.otenet.gr/files/test1Mb.db" 2>/dev/null; then
        local end_time=$(date +%s.%N)
        local duration=$(echo "$end_time - $start_time" | bc 2>/dev/null || echo "1")
        local file_size=$(stat -f%z "$test_file" 2>/dev/null || stat -c%s "$test_file" 2>/dev/null || echo "1048576")
        local speed_bps=$(echo "scale=2; $file_size / $duration" | bc 2>/dev/null || echo "0")
        local speed_mbps=$(echo "scale=2; $speed_bps / 1048576 * 8" | bc 2>/dev/null || echo "0")
        
        echo -e "${GREEN}Download speed: ~${speed_mbps} Mbps${NC}"
    else
        echo -e "${RED}Speed test failed${NC}"
    fi
    
    # Cleanup
    rm -f "$test_file"
    echo
}

# Main display function
main() {
    echo -e "${WHITE}========================================${NC}"
    echo -e "${WHITE}        NETWORK INFORMATION             ${NC}"
    echo -e "${WHITE}========================================${NC}"
    echo -e "${GREEN}Hostname:${NC} $(hostname)"
    echo -e "${GREEN}Date:${NC} $(date)"
    echo

    # Basic network information
    echo -e "${CYAN}üåê NETWORK OVERVIEW${NC}"
    echo -e "${GREEN}Default Gateway:${NC} $(get_default_gateway)"
    echo -e "${GREEN}DNS Servers:${NC} $(get_dns_servers)"
    echo -e "${GREEN}Public IP:${NC} $(get_public_ip)"
    echo

    # Network interfaces
    echo -e "${CYAN}üîå NETWORK INTERFACES${NC}"
    if command_exists ip; then
        # Get all interfaces except loopback
        local interfaces=$(ip link show | grep -E "^[0-9]+:" | grep -v "lo:" | awk -F': ' '{print $2}' | cut -d'@' -f1)
    elif command_exists ifconfig; then
        local interfaces=$(ifconfig -a | grep -E "^[a-zA-Z]" | grep -v "lo" | awk '{print $1}' | cut -d':' -f1)
    else
        echo -e "${RED}No network interface command available${NC}"
        return 1
    fi

    for interface in $interfaces; do
        get_interface_details "$interface"
    done

    # Wireless information
    show_wireless_info

    # Connectivity tests
    echo -e "${CYAN}üîç CONNECTIVITY TESTS${NC}"
    test_connectivity "8.8.8.8" "Google DNS"
    test_connectivity "1.1.1.1" "Cloudflare DNS"
    test_connectivity "google.com" "Google.com"
    test_connectivity "github.com" "GitHub.com"
    echo

    # Active connections
    show_active_connections

    # Routing table
    show_routing_table

    # Speed test
    if command_exists curl && command_exists bc; then
        perform_speed_test
    fi

    # Additional network tools information
    echo -e "${CYAN}üõ†Ô∏è  AVAILABLE NETWORK TOOLS${NC}"
    local tools=(
        "ping:Basic connectivity testing"
        "traceroute:Route tracing"
        "nslookup:DNS lookup"
        "dig:DNS lookup (advanced)"
        "wget:File downloading"
        "curl:HTTP client"
        "ssh:Secure shell"
        "scp:Secure copy"
        "rsync:File synchronization"
        "netstat:Network statistics"
        "ss:Socket statistics"
        "iperf3:Network performance"
        "tcpdump:Packet capture"
        "wireshark:Network analysis"
    )

    for tool_info in "${tools[@]}"; do
        local tool=$(echo "$tool_info" | cut -d':' -f1)
        local description=$(echo "$tool_info" | cut -d':' -f2)
        
        if command_exists "$tool"; then
            echo -e "  ${GREEN}‚úì $tool${NC} - $description"
        else
            echo -e "  ${RED}‚úó $tool${NC} - $description"
        fi
    done
    echo

    # Troubleshooting tips
    echo -e "${CYAN}üí° TROUBLESHOOTING TIPS${NC}"
    echo -e "  ‚Ä¢ ${YELLOW}ping${NC} - Test basic connectivity"
    echo -e "  ‚Ä¢ ${YELLOW}traceroute${NC} - Find network path issues"
    echo -e "  ‚Ä¢ ${YELLOW}nslookup${NC} - Test DNS resolution"
    echo -e "  ‚Ä¢ ${YELLOW}ip route${NC} - Check routing table"
    echo -e "  ‚Ä¢ ${YELLOW}ss -tuln${NC} - Check listening ports"
    echo -e "  ‚Ä¢ ${YELLOW}sudo tcpdump -i any${NC} - Monitor network traffic"
    echo

    echo -e "${WHITE}========================================${NC}"
}

# Check for help argument
if [[ "$1" == "-h" || "$1" == "--help" ]]; then
    echo "Network Information Tool"
    echo
    echo "Usage: $0"
    echo
    echo "This script displays comprehensive network information including:"
    echo "  ‚Ä¢ Network interfaces and their configuration"
    echo "  ‚Ä¢ Connectivity status and tests"
    echo "  ‚Ä¢ Wireless information (if available)"
    echo "  ‚Ä¢ Active connections and routing"
    echo "  ‚Ä¢ Available network tools"
    echo
    echo "No arguments required - just run the script!"
    exit 0
fi

# Run main function
main
