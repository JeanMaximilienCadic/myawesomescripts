#!/bin/bash

# System Monitor Script
# Monitors system resources and alerts when thresholds are exceeded

set -e

# Configuration
CPU_THRESHOLD=${CPU_THRESHOLD:-80}
MEMORY_THRESHOLD=${MEMORY_THRESHOLD:-85}
DISK_THRESHOLD=${DISK_THRESHOLD:-90}
LOAD_THRESHOLD=${LOAD_THRESHOLD:-4.0}
INTERVAL=${INTERVAL:-5}

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
MAGENTA='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m'

# Function to display usage
usage() {
    echo "Usage: $0 [OPTIONS]"
    echo "Options:"
    echo "  -c, --cpu THRESHOLD      CPU usage threshold (default: 80%)"
    echo "  -m, --memory THRESHOLD   Memory usage threshold (default: 85%)"
    echo "  -d, --disk THRESHOLD     Disk usage threshold (default: 90%)"
    echo "  -l, --load THRESHOLD     Load average threshold (default: 4.0)"
    echo "  -i, --interval SECONDS   Check interval (default: 5 seconds)"
    echo "  -o, --once              Run once and exit (no continuous monitoring)"
    echo "  -h, --help              Show this help message"
    echo
    echo "Environment variables can also be used:"
    echo "  CPU_THRESHOLD, MEMORY_THRESHOLD, DISK_THRESHOLD, LOAD_THRESHOLD, INTERVAL"
    exit 0
}

# Parse command line arguments
ONCE_MODE=false
while [[ $# -gt 0 ]]; do
    case $1 in
        -c|--cpu)
            CPU_THRESHOLD="$2"
            shift 2
            ;;
        -m|--memory)
            MEMORY_THRESHOLD="$2"
            shift 2
            ;;
        -d|--disk)
            DISK_THRESHOLD="$2"
            shift 2
            ;;
        -l|--load)
            LOAD_THRESHOLD="$2"
            shift 2
            ;;
        -i|--interval)
            INTERVAL="$2"
            shift 2
            ;;
        -o|--once)
            ONCE_MODE=true
            shift
            ;;
        -h|--help)
            usage
            ;;
        *)
            echo "Unknown option: $1"
            usage
            ;;
    esac
done

# Function to get CPU usage
get_cpu_usage() {
    grep 'cpu ' /proc/stat | awk '{usage=($2+$4)*100/($2+$4+$5)} END {print usage}'
}

# Function to get memory usage percentage
get_memory_usage() {
    free | grep Mem | awk '{printf "%.1f", $3/$2 * 100.0}'
}

# Function to get disk usage for root partition
get_disk_usage() {
    df / | tail -1 | awk '{print $5}' | sed 's/%//'
}

# Function to get load average (1 minute)
get_load_average() {
    cat /proc/loadavg | awk '{print $1}'
}

# Function to get top CPU processes
get_top_cpu_processes() {
    ps aux --sort=-%cpu | head -6 | tail -5 | awk '{printf "  %s (%.1f%%)\n", $11, $3}'
}

# Function to get top memory processes
get_top_memory_processes() {
    ps aux --sort=-%mem | head -6 | tail -5 | awk '{printf "  %s (%.1f%%)\n", $11, $4}'
}

# Function to check and display alerts
check_system() {
    local timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    local alerts=()
    
    echo -e "${CYAN}=== System Monitor - $timestamp ===${NC}"
    
    # Check CPU
    local cpu_usage=$(get_cpu_usage)
    local cpu_int=${cpu_usage%.*}
    if (( cpu_int > CPU_THRESHOLD )); then
        echo -e "${RED}ðŸ”¥ CPU: ${cpu_usage}% (ALERT - Above ${CPU_THRESHOLD}%)${NC}"
        alerts+=("CPU")
        echo -e "${YELLOW}Top CPU processes:${NC}"
        get_top_cpu_processes
    else
        echo -e "${GREEN}âœ“ CPU: ${cpu_usage}%${NC}"
    fi
    
    # Check Memory
    local memory_usage=$(get_memory_usage)
    local memory_int=${memory_usage%.*}
    if (( memory_int > MEMORY_THRESHOLD )); then
        echo -e "${RED}ðŸ§  Memory: ${memory_usage}% (ALERT - Above ${MEMORY_THRESHOLD}%)${NC}"
        alerts+=("Memory")
        echo -e "${YELLOW}Top Memory processes:${NC}"
        get_top_memory_processes
    else
        echo -e "${GREEN}âœ“ Memory: ${memory_usage}%${NC}"
    fi
    
    # Check Disk
    local disk_usage=$(get_disk_usage)
    if (( disk_usage > DISK_THRESHOLD )); then
        echo -e "${RED}ðŸ’¾ Disk: ${disk_usage}% (ALERT - Above ${DISK_THRESHOLD}%)${NC}"
        alerts+=("Disk")
        echo -e "${YELLOW}Largest directories in /:${NC}"
        du -h --max-depth=1 / 2>/dev/null | sort -hr | head -5 | sed 's/^/  /'
    else
        echo -e "${GREEN}âœ“ Disk: ${disk_usage}%${NC}"
    fi
    
    # Check Load Average
    local load_avg=$(get_load_average)
    local load_comparison=$(echo "$load_avg > $LOAD_THRESHOLD" | bc -l 2>/dev/null || echo "0")
    if [[ $load_comparison == "1" ]]; then
        echo -e "${RED}âš¡ Load: ${load_avg} (ALERT - Above ${LOAD_THRESHOLD})${NC}"
        alerts+=("Load")
    else
        echo -e "${GREEN}âœ“ Load: ${load_avg}${NC}"
    fi
    
    # Network connections
    local connections=$(ss -tuln | wc -l)
    echo -e "${BLUE}ðŸŒ Network connections: $((connections - 1))${NC}"
    
    # Uptime
    local uptime=$(uptime -p 2>/dev/null || uptime | cut -d',' -f1 | cut -d' ' -f3-)
    echo -e "${BLUE}â±ï¸  Uptime: ${uptime}${NC}"
    
    # Summary
    if [ ${#alerts[@]} -gt 0 ]; then
        echo -e "\n${RED}âš ï¸  ALERTS: ${alerts[*]}${NC}"
        
        # Log to syslog if available
        if command -v logger >/dev/null 2>&1; then
            logger "System Monitor Alert: ${alerts[*]} - CPU:${cpu_usage}% MEM:${memory_usage}% DISK:${disk_usage}% LOAD:${load_avg}"
        fi
    else
        echo -e "\n${GREEN}âœ… All systems normal${NC}"
    fi
    
    echo -e "${CYAN}===========================================${NC}\n"
}

# Function to handle Ctrl+C
cleanup() {
    echo -e "\n${YELLOW}Monitoring stopped.${NC}"
    exit 0
}

# Set trap for cleanup
trap cleanup INT TERM

# Main execution
echo -e "${BLUE}ðŸ–¥ï¸  System Monitor Started${NC}"
echo -e "${BLUE}Thresholds: CPU>${CPU_THRESHOLD}% Memory>${MEMORY_THRESHOLD}% Disk>${DISK_THRESHOLD}% Load>${LOAD_THRESHOLD}${NC}"

if [ "$ONCE_MODE" = true ]; then
    echo -e "${BLUE}Running in single-check mode...${NC}\n"
    check_system
else
    echo -e "${BLUE}Monitoring every ${INTERVAL} seconds... (Press Ctrl+C to stop)${NC}\n"
    
    while true; do
        check_system
        sleep "$INTERVAL"
    done
fi
