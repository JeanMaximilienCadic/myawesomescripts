#!/bin/bash

# System Cleanup Script
# Cleans up temporary files, logs, and package cache to free up disk space

set -e

# Colors
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
BLUE='\033[0;34m'
NC='\033[0m'

# Function to get directory size
get_size() {
    du -sh "$1" 2>/dev/null | cut -f1 || echo "0B"
}

# Function to safely remove files/directories
safe_remove() {
    local path="$1"
    local description="$2"
    
    if [ -e "$path" ]; then
        local size=$(get_size "$path")
        echo -e "${YELLOW}Cleaning $description...${NC} ($size)"
        if [ -d "$path" ]; then
            rm -rf "$path"/* 2>/dev/null || true
        else
            rm -f "$path" 2>/dev/null || true
        fi
        echo -e "${GREEN}âœ“ Done${NC}"
    else
        echo -e "${BLUE}â„¹ $description not found or already clean${NC}"
    fi
}

echo -e "${BLUE}ğŸ§¹ SYSTEM CLEANUP UTILITY${NC}"
echo -e "${BLUE}=========================${NC}"
echo

# Check if running as root for system-wide cleanup
if [[ $EUID -eq 0 ]]; then
    echo -e "${YELLOW}âš ï¸  Running as root - performing system-wide cleanup${NC}"
    SYSTEM_CLEANUP=true
else
    echo -e "${YELLOW}â„¹  Running as user - performing user-level cleanup${NC}"
    SYSTEM_CLEANUP=false
fi
echo

# Get initial disk usage
echo -e "${BLUE}ğŸ“Š Current disk usage:${NC}"
df -h / | tail -1
echo

# 1. Clean temporary files
echo -e "${BLUE}1. Cleaning temporary files...${NC}"
safe_remove "/tmp/*" "system temp files"
safe_remove "$HOME/.cache/thumbnails" "thumbnail cache"
safe_remove "$HOME/.local/share/Trash" "user trash"

# 2. Clean browser caches (common browsers)
echo -e "\n${BLUE}2. Cleaning browser caches...${NC}"
safe_remove "$HOME/.cache/google-chrome" "Chrome cache"
safe_remove "$HOME/.cache/mozilla" "Firefox cache"
safe_remove "$HOME/.cache/chromium" "Chromium cache"

# 3. Clean package manager caches
echo -e "\n${BLUE}3. Cleaning package caches...${NC}"
if command -v apt &> /dev/null; then
    if [ "$SYSTEM_CLEANUP" = true ]; then
        echo -e "${YELLOW}Cleaning APT cache...${NC}"
        apt autoremove -y &>/dev/null || true
        apt autoclean &>/dev/null || true
        apt clean &>/dev/null || true
        echo -e "${GREEN}âœ“ APT cache cleaned${NC}"
    else
        echo -e "${YELLOW}âš ï¸  APT cleanup requires root privileges${NC}"
    fi
fi

if command -v dnf &> /dev/null; then
    if [ "$SYSTEM_CLEANUP" = true ]; then
        echo -e "${YELLOW}Cleaning DNF cache...${NC}"
        dnf autoremove -y &>/dev/null || true
        dnf clean all &>/dev/null || true
        echo -e "${GREEN}âœ“ DNF cache cleaned${NC}"
    else
        echo -e "${YELLOW}âš ï¸  DNF cleanup requires root privileges${NC}"
    fi
fi

if command -v yum &> /dev/null; then
    if [ "$SYSTEM_CLEANUP" = true ]; then
        echo -e "${YELLOW}Cleaning YUM cache...${NC}"
        yum autoremove -y &>/dev/null || true
        yum clean all &>/dev/null || true
        echo -e "${GREEN}âœ“ YUM cache cleaned${NC}"
    else
        echo -e "${YELLOW}âš ï¸  YUM cleanup requires root privileges${NC}"
    fi
fi

# 4. Clean development tool caches
echo -e "\n${BLUE}4. Cleaning development caches...${NC}"
safe_remove "$HOME/.npm/_cacache" "NPM cache"
safe_remove "$HOME/.yarn/cache" "Yarn cache"
safe_remove "$HOME/.cache/pip" "pip cache"
safe_remove "$HOME/.cargo/registry/cache" "Cargo cache"
safe_remove "$HOME/.gradle/caches" "Gradle cache"

# 5. Clean log files
echo -e "\n${BLUE}5. Cleaning log files...${NC}"
if [ "$SYSTEM_CLEANUP" = true ]; then
    # Clean system logs (keep last 7 days)
    if command -v journalctl &> /dev/null; then
        echo -e "${YELLOW}Cleaning system journals...${NC}"
        journalctl --vacuum-time=7d &>/dev/null || true
        echo -e "${GREEN}âœ“ System journals cleaned${NC}"
    fi
    
    # Clean old log files
    find /var/log -name "*.log.*.gz" -mtime +30 -delete 2>/dev/null || true
    find /var/log -name "*.log.[0-9]*" -mtime +7 -delete 2>/dev/null || true
fi

# Clean user logs
safe_remove "$HOME/.xsession-errors*" "X session errors"
safe_remove "$HOME/.local/share/recently-used.xbel*" "recent files cache"

# 6. Clean Docker (if installed)
echo -e "\n${BLUE}6. Cleaning Docker...${NC}"
if command -v docker &> /dev/null; then
    if groups $USER | grep -q docker || [ "$SYSTEM_CLEANUP" = true ]; then
        echo -e "${YELLOW}Cleaning Docker system...${NC}"
        docker system prune -f &>/dev/null || true
        docker image prune -f &>/dev/null || true
        docker container prune -f &>/dev/null || true
        docker volume prune -f &>/dev/null || true
        echo -e "${GREEN}âœ“ Docker system cleaned${NC}"
    else
        echo -e "${YELLOW}âš ï¸  Docker cleanup requires docker group membership or root${NC}"
    fi
else
    echo -e "${BLUE}â„¹  Docker not installed${NC}"
fi

# 7. Clean flatpak cache (if installed)
echo -e "\n${BLUE}7. Cleaning Flatpak...${NC}"
if command -v flatpak &> /dev/null; then
    echo -e "${YELLOW}Cleaning unused Flatpak runtimes...${NC}"
    flatpak uninstall --unused -y &>/dev/null || true
    echo -e "${GREEN}âœ“ Flatpak cleaned${NC}"
else
    echo -e "${BLUE}â„¹  Flatpak not installed${NC}"
fi

# 8. Clean snap cache (if installed)
echo -e "\n${BLUE}8. Cleaning Snap packages...${NC}"
if command -v snap &> /dev/null; then
    if [ "$SYSTEM_CLEANUP" = true ]; then
        echo -e "${YELLOW}Cleaning old snap revisions...${NC}"
        snap list --all | awk '/disabled/{print $1, $3}' | while read snapname revision; do
            snap remove "$snapname" --revision="$revision" 2>/dev/null || true
        done
        echo -e "${GREEN}âœ“ Snap packages cleaned${NC}"
    else
        echo -e "${YELLOW}âš ï¸  Snap cleanup requires root privileges${NC}"
    fi
else
    echo -e "${BLUE}â„¹  Snap not installed${NC}"
fi

echo
echo -e "${BLUE}ğŸ“Š Disk usage after cleanup:${NC}"
df -h / | tail -1
echo

echo -e "${GREEN}ğŸ‰ Cleanup completed!${NC}"
echo -e "${YELLOW}ğŸ’¡ Tip: Run this script regularly to keep your system clean${NC}"
echo -e "${YELLOW}ğŸ’¡ For system-wide cleanup, run with sudo${NC}"
